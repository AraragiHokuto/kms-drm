#############

kfd_device:

kfd_device.c:139:35: error: use of undeclared identifier 'AMD_IOMMU_DEVICE_FLAG_ATS_SUP'
        const u32 required_iommu_flags = AMD_IOMMU_DEVICE_FLAG_ATS_SUP |
                                         ^
kfd_device.c:140:6: error: use of undeclared identifier 'AMD_IOMMU_DEVICE_FLAG_PRI_SUP'
                                        AMD_IOMMU_DEVICE_FLAG_PRI_SUP |
                                        ^
kfd_device.c:141:6: error: use of undeclared identifier 'AMD_IOMMU_DEVICE_FLAG_PASID_SUP'
                                        AMD_IOMMU_DEVICE_FLAG_PASID_SUP;
                                        ^
kfd_device.c:143:31: error: variable has incomplete type 'struct amd_iommu_device_info'
        struct amd_iommu_device_info iommu_info;
                                     ^
kfd_device.c:143:9: note: forward declaration of 'struct amd_iommu_device_info'
        struct amd_iommu_device_info iommu_info;
               ^
kfd_device.c:147:8: error: implicit declaration of function 'amd_iommu_device_info' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        err = amd_iommu_device_info(kfd->pdev, &iommu_info);
              ^
kfd_device.c:147:8: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_device.c:156:30: error: use of undeclared identifier 'AMD_IOMMU_DEVICE_FLAG_ATS_SUP'
                       (iommu_info.flags & AMD_IOMMU_DEVICE_FLAG_ATS_SUP) != 0,
                                           ^
kfd_device.c:157:30: error: use of undeclared identifier 'AMD_IOMMU_DEVICE_FLAG_PRI_SUP'
                       (iommu_info.flags & AMD_IOMMU_DEVICE_FLAG_PRI_SUP) != 0,
                                           ^
kfd_device.c:158:30: error: use of undeclared identifier 'AMD_IOMMU_DEVICE_FLAG_PASID_SUP'
                       (iommu_info.flags & AMD_IOMMU_DEVICE_FLAG_PASID_SUP) != 0);
                                           ^
kfd_device.c:173:8: error: implicit declaration of function 'amd_iommu_init_device' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        err = amd_iommu_init_device(kfd->pdev, pasid_limit);
              ^
kfd_device.c:173:8: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_device.c:181:3: error: implicit declaration of function 'amd_iommu_free_device' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
                amd_iommu_free_device(kfd->pdev);
                ^
kfd_device.c:181:3: note: did you mean 'amd_iommu_init_device'?
kfd_device.c:173:8: note: 'amd_iommu_init_device' declared here
        err = amd_iommu_init_device(kfd->pdev, pasid_limit);
              ^
kfd_device.c:181:3: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
                amd_iommu_free_device(kfd->pdev);


############
kfd_chardev:

kfd_chardev.c:49:3: error: field designator 'compat_ioctl' does not refer to any field in type 'const struct file_operations'
        .compat_ioctl = kfd_ioctl,
         ^
kfd_chardev.c:110:23: error: implicit declaration of function 'in_compat_syscall' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        is_32bit_user_mode = in_compat_syscall();
                             ^
kfd_chardev.c:110:23: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_chardev.c:715:20: error: variable has incomplete type 'struct timespec64'
        struct timespec64 time;
                          ^
kfd_chardev.c:715:9: note: forward declaration of 'struct timespec64'
        struct timespec64 time;
               ^
kfd_chardev.c:726:2: error: implicit declaration of function 'getrawmonotonic64' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        getrawmonotonic64(&time);
        ^
kfd_chardev.c:726:2: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_chardev.c:727:38: error: implicit declaration of function 'timespec64_to_ns' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        args->cpu_clock_counter = (uint64_t)timespec64_to_ns(&time);
                                            ^
kfd_chardev.c:727:38: note: did you mean 'timespec_to_ns'?
/usr/src/sys/compat/linuxkpi/common/include/linux/time.h:90:1: note: 'timespec_to_ns' declared here
timespec_to_ns(const struct timespec *ts)
^
kfd_chardev.c:727:38: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
        args->cpu_clock_counter = (uint64_t)timespec64_to_ns(&time);
                                            ^
kfd_chardev.c:729:2: error: implicit declaration of function 'get_monotonic_boottime64' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        get_monotonic_boottime64(&time);
        ^
kfd_chardev.c:729:2: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_chardev.c:855:2: error: implicit declaration of function '_IOC_NR' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        AMDKFD_IOCTL_DEF(AMDKFD_IOC_GET_VERSION,
        ^
kfd_chardev.c:851:3: note: expanded from macro 'AMDKFD_IOCTL_DEF'
        [_IOC_NR(ioctl)] = {.cmd = ioctl, .func = _func, .flags = _flags, .cmd_drv = 0, .name = #ioctl}
         ^
kfd_chardev.c:855:2: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_chardev.c:851:3: note: expanded from macro 'AMDKFD_IOCTL_DEF'
        [_IOC_NR(ioctl)] = {.cmd = ioctl, .func = _func, .flags = _flags, .cmd_drv = 0, .name = #ioctl}
         ^
kfd_chardev.c:855:2: error: expression is not an integer constant expression
        AMDKFD_IOCTL_DEF(AMDKFD_IOC_GET_VERSION,
        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kfd_chardev.c:851:3: note: expanded from macro 'AMDKFD_IOCTL_DEF'
        [_IOC_NR(ioctl)] = {.cmd = ioctl, .func = _func, .flags = _flags, .cmd_drv = 0, .name = #ioctl}
         ^~~~~~~~~~~~~~
kfd_chardev.c:858:2: error: expression is not an integer constant expression
        AMDKFD_IOCTL_DEF(AMDKFD_IOC_CREATE_QUEUE,
        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kfd_chardev.c:851:3: note: expanded from macro 'AMDKFD_IOCTL_DEF'
        [_IOC_NR(ioctl)] = {.cmd = ioctl, .func = _func, .flags = _flags, .cmd_drv = 0, .name = #ioctl}
         ^~~~~~~~~~~~~~
kfd_chardev.c:861:2: error: expression is not an integer constant expression
        AMDKFD_IOCTL_DEF(AMDKFD_IOC_DESTROY_QUEUE,
        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kfd_chardev.c:851:3: note: expanded from macro 'AMDKFD_IOCTL_DEF'
        [_IOC_NR(ioctl)] = {.cmd = ioctl, .func = _func, .flags = _flags, .cmd_drv = 0, .name = #ioctl}
         ^~~~~~~~~~~~~~
kfd_chardev.c:864:2: error: expression is not an integer constant expression
        AMDKFD_IOCTL_DEF(AMDKFD_IOC_SET_MEMORY_POLICY,
        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kfd_chardev.c:851:3: note: expanded from macro 'AMDKFD_IOCTL_DEF'
        [_IOC_NR(ioctl)] = {.cmd = ioctl, .func = _func, .flags = _flags, .cmd_drv = 0, .name = #ioctl}
         ^~~~~~~~~~~~~~
kfd_chardev.c:867:2: error: expression is not an integer constant expression
        AMDKFD_IOCTL_DEF(AMDKFD_IOC_GET_CLOCK_COUNTERS,
        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kfd_chardev.c:851:3: note: expanded from macro 'AMDKFD_IOCTL_DEF'
        [_IOC_NR(ioctl)] = {.cmd = ioctl, .func = _func, .flags = _flags, .cmd_drv = 0, .name = #ioctl}
         ^~~~~~~~~~~~~~
kfd_chardev.c:870:2: error: expression is not an integer constant expression
        AMDKFD_IOCTL_DEF(AMDKFD_IOC_GET_PROCESS_APERTURES,
        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kfd_chardev.c:851:3: note: expanded from macro 'AMDKFD_IOCTL_DEF'
        [_IOC_NR(ioctl)] = {.cmd = ioctl, .func = _func, .flags = _flags, .cmd_drv = 0, .name = #ioctl}
         ^~~~~~~~~~~~~~
kfd_chardev.c:873:2: error: expression is not an integer constant expression
        AMDKFD_IOCTL_DEF(AMDKFD_IOC_UPDATE_QUEUE,
        ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kfd_chardev.c:851:3: note: expanded from macro 'AMDKFD_IOCTL_DEF'
        [_IOC_NR(ioctl)] = {.cmd = ioctl, .func = _func, .flags = _flags, .cmd_drv = 0, .name = #ioctl}
         ^~~~~~~~~~~~~~
fatal error: too many errors emitted, stopping now [-ferror-limit=]
20 errors generated.
*** Error code 1

########

kfd_process:

kfd_process.c:51:1: error: type specifier missing, defaults to 'int' [-Werror,-Wimplicit-int]
DEFINE_STATIC_SRCU(kfd_processes_srcu);
^
kfd_process.c:51:20: error: a parameter list without types is only allowed in a function definition
DEFINE_STATIC_SRCU(kfd_processes_srcu);
                   ^
kfd_process.c:87:14: error: no member named 'group_leader' in 'struct task_struct'
        if (thread->group_leader->mm != thread->mm)
            ~~~~~~  ^
kfd_process.c:123:14: error: no member named 'group_leader' in 'struct task_struct'
        if (thread->group_leader->mm != thread->mm)
            ~~~~~~  ^
kfd_process.c:148:8: error: implicit declaration of function 'srcu_read_lock' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        idx = srcu_read_lock(&kfd_processes_srcu);
              ^
kfd_process.c:148:8: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_process.c:148:24: error: use of undeclared identifier 'kfd_processes_srcu'
        idx = srcu_read_lock(&kfd_processes_srcu);
                              ^
kfd_process.c:150:2: error: implicit declaration of function 'srcu_read_unlock' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        srcu_read_unlock(&kfd_processes_srcu, idx);
        ^
kfd_process.c:150:2: note: did you mean 'srcu_read_lock'?
kfd_process.c:148:8: note: 'srcu_read_lock' declared here
        idx = srcu_read_lock(&kfd_processes_srcu);
              ^
kfd_process.c:150:2: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
        srcu_read_unlock(&kfd_processes_srcu, idx);
        ^
kfd_process.c:150:20: error: use of undeclared identifier 'kfd_processes_srcu'
        srcu_read_unlock(&kfd_processes_srcu, idx);
                          ^
kfd_process.c:178:3: error: implicit declaration of function 'amd_iommu_unbind_pasid' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
                amd_iommu_unbind_pasid(pdd->dev->pdev, p->pasid);
                ^
kfd_process.c:178:3: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_process.c:236:2: error: implicit declaration of function 'synchronize_srcu' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        synchronize_srcu(&kfd_processes_srcu);
        ^
kfd_process.c:236:2: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_process.c:236:20: error: use of undeclared identifier 'kfd_processes_srcu'
        synchronize_srcu(&kfd_processes_srcu);
                          ^
kfd_process.c:266:2: error: implicit declaration of function 'mmu_notifier_unregister_no_release' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        mmu_notifier_unregister_no_release(&p->mmu_notifier, p->mm);
        ^
kfd_process.c:266:2: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_process.c:267:2: error: implicit declaration of function 'mmu_notifier_call_srcu' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
        mmu_notifier_call_srcu(&p->rcu, &kfd_process_destroy_delayed);
        ^
kfd_process.c:267:2: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
fatal error: too many errors emitted, stopping now [-ferror-limit=]
20 errors generated.
*** Error code 1

Stop.

#########


kfd_topology:

Includes acpi functionality and misses opt_acpi.h:

In file included from kfd_topology.c:27:
In file included from /usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/acpi.h:32:
In file included from /usr/src/sys/contrib/dev/acpica/include/acpi.h:164:
In file included from /usr/src/sys/contrib/dev/acpica/include/platform/acenv.h:303:
/usr/src/sys/contrib/dev/acpica/include/platform/acfreebsd.h:184:10: fatal error: 'opt_acpi.h' file not found
#include "opt_acpi.h"
         ^~~~~~~~~~~~
1 error generated.

If an empty opt_acpi.h is added:

In file included from kfd_topology.c:27:
In file included from /usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/acpi.h:35:
/usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/acpi/acpi_drivers.h:105:41: error: declaration of
      'struct acpi_device' will not be visible outside of this function [-Werror,-Wvisibility]
static inline int is_dock_device(struct acpi_device *adev)
                                        ^
In file included from kfd_topology.c:27:
/usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/acpi.h:37:53: error: declaration of
      'struct acpi_device' will not be visible outside of this function [-Werror,-Wvisibility]
static inline acpi_handle acpi_device_handle(struct acpi_device *adev)
                                                    ^
/usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/acpi.h:39:20: error: incomplete definition of
      type 'struct acpi_device'
        return adev ? adev->handle : NULL;
                      ~~~~^
/usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/acpi.h:37:53: note: forward declaration of
      'struct acpi_device'
static inline acpi_handle acpi_device_handle(struct acpi_device *adev)
                                                    ^
/usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/acpi.h:61:48: error: declaration of
      'struct acpi_device' will not be visible outside of this function [-Werror,-Wvisibility]
static inline const char *acpi_dev_name(struct acpi_device *adev)
                                               ^
/usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/acpi.h:63:23: error: incomplete definition of
      type 'struct acpi_device'
        return dev_name(&adev->dev);
                         ~~~~^
/usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/acpi.h:61:48: note: forward declaration of
      'struct acpi_device'
static inline const char *acpi_dev_name(struct acpi_device *adev)
                                               ^
/usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/acpi.h:71:52: error: declaration of
      'struct acpi_device' will not be visible outside of this function [-Werror,-Wvisibility]
int acpi_bus_get_device(acpi_handle handle, struct acpi_device **device);
                                                   ^
kfd_topology.c:100:27: error: no member named 'length' in 'struct acpi_table_header'; did you mean 'Length'?
        if (*size >= crat_table->length && crat_image != NULL)
                                 ^~~~~~
                                 Length
/usr/src/sys/contrib/dev/acpica/include/actbl.h:216:29: note: 'Length' declared here
    UINT32                  Length;                             /* Length of table in bytes, including this header */
                            ^
kfd_topology.c:101:46: error: no member named 'length' in 'struct acpi_table_header'; did you mean 'Length'?
                memcpy(crat_image, crat_table, crat_table->length);
                                                           ^~~~~~
                                                           Length
/usr/src/sys/contrib/dev/acpica/include/actbl.h:216:29: note: 'Length' declared here
    UINT32                  Length;                             /* Length of table in bytes, including this header */
                            ^
kfd_topology.c:103:22: error: no member named 'length' in 'struct acpi_table_header'; did you mean 'Length'?
        *size = crat_table->length;
                            ^~~~~~
                            Length
/usr/src/sys/contrib/dev/acpica/include/actbl.h:216:29: note: 'Length' declared here
    UINT32                  Length;                             /* Length of table in bytes, including this header */
                            ^
kfd_topology.c:510:5: error: format specifies type 'unsigned long long' but the argument has type 'uint64_t'
      (aka 'unsigned long') [-Werror,-Wformat]
                                sys_props.platform_oem);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~~
kfd_topology.c:492:50: note: expanded from macro 'sysfs_show_64bit_prop'
                sysfs_show_gen_prop(buffer, "%s %llu\n", name, value)
                                                ~~~~           ^~~~~
kfd_topology.c:488:48: note: expanded from macro 'sysfs_show_gen_prop'
                snprintf(buffer, PAGE_SIZE, "%s"fmt, buffer, __VA_ARGS__)
                                                             ^~~~~~~~~~~
kfd_topology.c:512:5: error: format specifies type 'unsigned long long' but the argument has type 'uint64_t'
      (aka 'unsigned long') [-Werror,-Wformat]
                                sys_props.platform_id);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~
kfd_topology.c:492:50: note: expanded from macro 'sysfs_show_64bit_prop'
                sysfs_show_gen_prop(buffer, "%s %llu\n", name, value)
                                                ~~~~           ^~~~~
kfd_topology.c:488:48: note: expanded from macro 'sysfs_show_gen_prop'
                snprintf(buffer, PAGE_SIZE, "%s"fmt, buffer, __VA_ARGS__)
                                                             ^~~~~~~~~~~
kfd_topology.c:514:5: error: format specifies type 'unsigned long long' but the argument has type 'uint64_t'
      (aka 'unsigned long') [-Werror,-Wformat]
                                sys_props.platform_rev);
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~~
kfd_topology.c:492:50: note: expanded from macro 'sysfs_show_64bit_prop'
                sysfs_show_gen_prop(buffer, "%s %llu\n", name, value)
                                                ~~~~           ^~~~~
kfd_topology.c:488:48: note: expanded from macro 'sysfs_show_gen_prop'
                snprintf(buffer, PAGE_SIZE, "%s"fmt, buffer, __VA_ARGS__)
                                                             ^~~~~~~~~~~
kfd_topology.c:576:49: error: format specifies type 'unsigned long long' but the argument has type 'uint64_t'
      (aka 'unsigned long') [-Werror,-Wformat]
        sysfs_show_64bit_prop(buffer, "size_in_bytes", mem->size_in_bytes);
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~
kfd_topology.c:492:50: note: expanded from macro 'sysfs_show_64bit_prop'
                sysfs_show_gen_prop(buffer, "%s %llu\n", name, value)
                                                ~~~~           ^~~~~
kfd_topology.c:488:48: note: expanded from macro 'sysfs_show_gen_prop'
                snprintf(buffer, PAGE_SIZE, "%s"fmt, buffer, __VA_ARGS__)
                                                             ^~~~~~~~~~~
kfd_topology.c:714:4: error: implicit declaration of function '__ilog2_u32' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
                        __ilog2_u32(dev->gpu->device_info->num_of_watch_points);
                        ^
kfd_topology.c:714:4: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
kfd_topology.c:742:6: error: implicit declaration of function 'cpufreq_quick_get_max' is invalid in C99
      [-Werror,-Wimplicit-function-declaration]
                                        cpufreq_quick_get_max(0)/1000);
                                        ^
kfd_topology.c:742:6: note: did you mean 'cpufreq_cpu_get_raw'?
/usr/ports/graphics/drm-next-kmod/work/kms-drm-fc90953/linuxkpi/gplv2/include/linux/cpufreq.h:42:1: note: 'cpufreq_cpu_get_raw'
      declared here
cpufreq_cpu_get_raw(unsigned int cpu)
^
kfd_topology.c:742:6: error: this function declaration is not a prototype [-Werror,-Wstrict-prototypes]
                                        cpufreq_quick_get_max(0)/1000);
                                        ^
17 errors generated.
*** Error code 1
